<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Case Study: Causal inference for observational data using modelbased • modelbased</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case Study: Causal inference for observational data using modelbased">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">modelbased</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.13.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-code"></span> Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-introductions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Introductions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-introductions">
<li><a class="dropdown-item" href="../articles/overview_of_vignettes.html">Overview of Vignettes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/visualisation_matrix.html">Data grids</a></li>
    <li><a class="dropdown-item" href="../articles/estimate_means.html">Marginal means</a></li>
    <li><a class="dropdown-item" href="../articles/estimate_contrasts.html">Contrast analysis</a></li>
    <li><a class="dropdown-item" href="../articles/estimate_slopes.html">Marginal effects and derivatives</a></li>
    <li><a class="dropdown-item" href="../articles/mixed_models.html">Mixed effects models</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Interpretation</h6></li>
    <li><a class="dropdown-item" href="../articles/estimate_response.html">Use a model to make predictions</a></li>
    <li><a class="dropdown-item" href="../articles/derivatives.html">Interpret models using Effect Derivatives</a></li>
    <li><a class="dropdown-item" href="../articles/estimate_grouplevel.html">Estimate and re-use Random Effects</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Visualization</h6></li>
    <li><a class="dropdown-item" href="../articles/plotting.html">Plotting estimated marginal means</a></li>
    <li><a class="dropdown-item" href="../articles/estimate_relation.html">Visualize effects and interactions</a></li>
    <li><a class="dropdown-item" href="../articles/modelisation_approach.html">The modelisation approach</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-case-studies" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Case Studies</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-case-studies">
<li><h6 class="dropdown-header" data-toc-skip>Workflows</h6></li>
    <li><a class="dropdown-item" href="../articles/workflow_modelbased.html">Understanding your models</a></li>
    <li><a class="dropdown-item" href="../articles/practical_causality.html">Causal inference for observational data</a></li>
    <li><a class="dropdown-item" href="../articles/practical_intersectionality.html">Intersectionality analysis using the MAIHDA framework</a></li>
    <li><a class="dropdown-item" href="../articles/practical_inequalities.html">Measuring and comparing absolute and relative inequalities</a></li>
    <li><a class="dropdown-item" href="../articles/practical_its.html">Interrupted Time Series Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/practical_growthmixture.html">An Introduction to Growth Mixture Models</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Contrasts</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction_comparisons_1.html">Contrasts and comparisons</a></li>
    <li><a class="dropdown-item" href="../articles/introduction_comparisons_2.html">User Defined Contrasts and Joint Tests</a></li>
    <li><a class="dropdown-item" href="../articles/introduction_comparisons_3.html">Slopes, floodlight and spotlight analysis (Johnson-Neyman intervals)</a></li>
    <li><a class="dropdown-item" href="../articles/introduction_comparisons_4.html">Contrasts and comparisons for generalized linear models</a></li>
    <li><a class="dropdown-item" href="../articles/introduction_comparisons_5.html">Contrasts and comparisons for zero-inflation models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper"></span> News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-easystats" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="easystats"><span class="fa fab fa-r-project"></span> easystats</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-easystats">
<li><a class="external-link dropdown-item" href="https://easystats.github.io/bayestestR/">bayestestR</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/correlation/">correlation</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/datawizard/">datawizard</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/easystats/">easystats</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/effectsize/">effectsize</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/insight/">insight</a></li>
    <li><a class="dropdown-item" href="https://easystats.github.io/modelbased/">modelbased</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/performance/">performance</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/parameters/">parameters</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/report/">report</a></li>
    <li><a class="external-link dropdown-item" href="https://easystats.github.io/see/">see</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="http://twitter.com/easystats4u" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/easystats/modelbased/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Case Study: Causal inference for observational data using modelbased</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/easystats/modelbased/blob/main/vignettes/practical_causality.Rmd" class="external-link"><code>vignettes/practical_causality.Rmd</code></a></small>
      <div class="d-none name"><code>practical_causality.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates how to perform causal inference with
observational data using the <code>modelbased</code> package. While the
examples below use the terms “treatment” and “control” groups, these
labels are arbitrary and interchangeable. Causal inference can be
applied to any scenario where observations are assigned to different
conditions, regardless of whether a “treatment” in the medical sense is
involved.</p>
<div class="section level3">
<h3 id="the-lack-of-randomization">The lack of randomization<a class="anchor" aria-label="anchor" href="#the-lack-of-randomization"></a>
</h3>
<p>Randomized controlled trials (RCTs) are frequently employed to
estimate the average treatment effect (ATE), which represents the
average difference in outcomes between individuals in the treatment and
control groups (i.e., how would the outcome differ, on average, if all
participants were treated versus if no participants was treated). In the
context of RCTs, the ATE can be interpreted as a causal effect.</p>
<p>Estimating causal effects with observational data, where treatment
and control group assignments are not randomized, presents a greater
challenge due to the potential for confounding bias. In observational
studies, individual characteristics associated with the outcome (e.g.,
age, gender, education, health status) are likely unequally distributed
between the treatment and control groups. This imbalance violates a key
assumption for causal effect estimation, an assumption typically
satisfied by randomization in RCTs but often unmet in observational
data.</p>
</div>
<div class="section level3">
<h3 id="propensity-scores-and-g-computation">Propensity scores and G-computation<a class="anchor" aria-label="anchor" href="#propensity-scores-and-g-computation"></a>
</h3>
<p>Two primary methods exist for addressing the lack of randomization in
observational data: propensity scores and g-computation. Regarding
propensity scores, this vignette focuses on <em>inverse probability
weighting</em> (IPW), a common technique for estimating propensity
scores <span class="citation">(Chatton and Rohrer 2024; Gabriel et al.
2024)</span>. Other established techniques involve <em>matching</em>
<span class="citation">(Ho et al. 2005)</span>, which are, however,
beyond the scope of this discussion.</p>
<p>IPW assigns weights to individual observations to reflect their
contribution to the outcome under the assumption of exchangeability
between groups. When specific characteristics are over-represented in
the treatment group, IPW assigns lower weights to these individuals,
thereby adjusting for the imbalanced distribution of confounders between
treatment and control groups.</p>
<p>G-computation, rooted in the traditional methods of stratification
and standardization, addresses confounding in observational studies by
partitioning the study population into strata, calculating
stratum-specific outcomes, and then weighting these outcomes to
represent a target population (e.g., the general population). In
<em>modelbased</em>, g-computation can be implemented by setting
<code>estimate = "population"</code>. This approach directly models
counterfactual scenarios by creating copies of each observation,
effectively assigning each individual to both treatment and control
conditions. The final estimate is then derived by averaging predictions
across these counterfactual observations <span class="citation">(Dickerman and Hernán 2020)</span>.</p>
<p>Both propensity score and g-computation methods offer distinct
advantages and disadvantages. IPW, for instance, can be directly
incorporated as weights within regression models, facilitating a
straightforward interpretation of the treatment coefficient as the
average treatment effect (ATE). However, deriving the ATE becomes more
complex in models incorporating interaction terms or other complexities.
Conversely, <em>modelbased</em> g-computation readily estimates the ATE
even within complex model specifications. A robust approach often
involves combining IPW and g-computation to achieve “doubly robust”
estimation of the ATE <span class="citation">(Chatton and Rohrer 2024;
Gabriel et al. 2024)</span>. Illustrative examples will follow.</p>
</div>
<div class="section level3">
<h3 id="calculating-inverse-probability-weights">Calculating inverse probability weights<a class="anchor" aria-label="anchor" href="#calculating-inverse-probability-weights"></a>
</h3>
<p>First, we create some toy data with a treatment effect that is
roughly 5 points higher than the effect in the control group. The
example data set has health related quality of life <code>QoL</code> as
outcome, which was measured for 188 cancer patient at three time points
(baseline, two follow-ups). The <code>treatment</code> variable is
simulated and not part of the original data set. Since we have repeated
measurements, we use the <code>glmmTMB</code> package to fit a linear
mixed model to the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/modelbased/">modelbased</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/datawizard/" class="external-link">datawizard</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/" class="external-link">parameters</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">qol_cancer</span>, package <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sort and group data by patient ID, then assign each patient either to</span></span>
<span><span class="co"># the treatment or control condition, with higher educated patients having</span></span>
<span><span class="co"># a higher chance belonging to the treatment group</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">qol_cancer</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://easystats.github.io/datawizard/reference/data_arrange.html" class="external-link">data_arrange</a></span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://easystats.github.io/datawizard/reference/data_group.html" class="external-link">data_group</a></span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://easystats.github.io/datawizard/reference/data_modify.html" class="external-link">data_modify</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">education</span> <span class="op">==</span> <span class="st">"high"</span>, <span class="fl">0.72</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://easystats.github.io/datawizard/reference/data_group.html" class="external-link">data_ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a treatment effect that increased over time</span></span>
<span><span class="co"># with more improvements for higher educated patients</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">QoL</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">QoL</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>,</span>
<span>  <span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">treatment</span> <span class="op">*</span> <span class="va">d</span><span class="op">$</span><span class="va">time</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">education</span> <span class="op">==</span> <span class="st">"high"</span>, <span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to factors</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://easystats.github.io/datawizard/reference/to_factor.html" class="external-link">to_factor</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"treatment"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We first look at the simple effect of <code>treatment</code>, which
is about 5.9.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simple pooled effect</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">glmmTMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">QoL</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we don't need the full summary table,</span></span>
<span><span class="co"># only the coefficient for treatment</span></span>
<span><span class="fu"><a href="https://easystats.github.io/parameters/reference/model_parameters.html" class="external-link">model_parameters</a></span><span class="op">(</span><span class="va">m1</span>, keep <span class="op">=</span> <span class="st">"^treatment"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Fixed Effects</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter     | Coefficient |   SE |       95% CI |    z |     p</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------</span></span>
<span><span class="co">#&gt; treatment [1] |        5.90 | 1.95 | [2.08, 9.71] | 3.03 | 0.002</span></span></code></pre></div>
<p>Next, inverse probability weights are calculated. This involves
employing a regression model with the predictor of interest,
<code>treatment</code>, as the outcome variable. This model estimates
the probability of observed confounder variables given the treatment
assignment. For binary predictors, such as the <code>treatment</code>
variable in this analysis, a logistic regression model is utilized.
Potential confounders serve as independent variables in this model,
generating predicted probabilities for each observation’s membership in
either the treatment or control group. Based on these probabilities, the
IPW is calculated.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># logistic regression model</span></span>
<span><span class="va">m_ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">treatment</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">age</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add predictions, i.e. the probability of belonging to treatment</span></span>
<span><span class="co"># or control for each patient in the sample (propensity score)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_ipw</span>, newdata <span class="op">=</span> <span class="va">d</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating the IPW</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>  <span class="fl">1</span> <span class="op">/</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span>, <span class="co"># IPW for treatment group</span></span>
<span>  <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span><span class="op">)</span> <span class="co"># IPW for control group</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculating-matching-and-overlap-weights">Calculating matching and overlap weights<a class="anchor" aria-label="anchor" href="#calculating-matching-and-overlap-weights"></a>
</h3>
<p>The IPW may suffer from extreme values, where certain observations
can get very high or low weights, because they have no good match in the
other group. Extreme weights can bias estimates and increase variance,
especially for the ATE. These weights may signal a need to shift focus
to the overlap population, where groups are more comparable. Two common
alternatives to IPW are <em>overlap weights</em> (OW) or <em>matching
weights</em> (MW), the latter acting as a weighting analog to pair
matching <span class="citation">(Li and Greene 2013; Kostouraki et al.
2024)</span>. While we demonstrate the calculation of Matching Weights
(MW) and Overlap Weights (OW) here, we will use Inverse Probability
Weighting (IPW) for illustrative purposes in the subsequent
examples.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculating matching weights</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">matching_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span><span class="op">)</span> <span class="op">/</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating overlap weights</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">overlap_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span><span class="op">$</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>  <span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span>,</span>
<span>  <span class="va">d</span><span class="op">$</span><span class="va">propensity_score</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ate-calculated-from-ipw-in-simpler-models">ATE calculated from IPW in simpler models<a class="anchor" aria-label="anchor" href="#ate-calculated-from-ipw-in-simpler-models"></a>
</h3>
<p>Now we run the same model again, including the weights. We see that
the treatment effect, after weighting, is about 5.58 points, i.e. the
treatment on average results in a QoL score that is 5.58 points higher
in comparison to the non-treated group.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">glmmTMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">QoL</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">ipw</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://easystats.github.io/parameters/reference/model_parameters.html" class="external-link">model_parameters</a></span><span class="op">(</span><span class="va">m2</span>, keep <span class="op">=</span> <span class="st">"^treatment"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Fixed Effects</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter     | Coefficient |   SE |       95% CI |    z |     p</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------</span></span>
<span><span class="co">#&gt; treatment [1] |        5.58 | 1.93 | [1.80, 9.35] | 2.90 | 0.004</span></span></code></pre></div>
<p>Given the simplicity of the model, g-computation offers no
significant advantage in calculating contrasts between
<code>treatment</code> levels, as the results are equivalent to a
simpler approach.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m2</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.58 (1.80, 9.35) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ate-calculated-from-ipw-and-g-computation-in-more-complex-models">ATE calculated from IPW and g-computation in more complex
models<a class="anchor" aria-label="anchor" href="#ate-calculated-from-ipw-and-g-computation-in-more-complex-models"></a>
</h3>
<p>However, we have not properly modelled the longitudinal nature of our
data. Since patients’ quality of life (QoL) was measured at three
distinct time points, allowing for an examination of treatment effects
over time, we need to include an interaction between
<code>treatment</code> and <code>time</code>. This revealed a
substantially greater increase in QoL over time within the treatment
group. In such more complex modeling scenarios, g-computation becomes
particularly advantageous.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># interaction terms involved</span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">glmmTMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">QoL</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">time</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">ipw</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimated marginal means, to show how treatment</span></span>
<span><span class="co"># develops over time between treatment and control conditions</span></span>
<span><span class="fu"><a href="../reference/estimate_means.html">estimate_means</a></span><span class="op">(</span></span>
<span>  <span class="va">m3</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"treatment"</span><span class="op">)</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="practical_causality_files/figure-html/unnamed-chunk-9-1.png" width="90%" height="90%"></p>
<p>We now see that the coefficient table is no longer helpful, because
the treatment effect cannot be isolated. If we want to know the ATE of
<code>treatment</code>, we need to calculate contrasts for the levels of
our <code>treatment</code> predictor.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ATE no longer visible from coefficient table</span></span>
<span><span class="fu"><a href="https://easystats.github.io/parameters/reference/model_parameters.html" class="external-link">model_parameters</a></span><span class="op">(</span><span class="va">m3</span>, keep <span class="op">=</span> <span class="st">"^treatment"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Fixed Effects</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter                | Coefficient |   SE |         95% CI |     z |      p</span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; treatment [1]            |       -0.53 | 2.13 | [-4.71,  3.64] | -0.25 | 0.802 </span></span>
<span><span class="co">#&gt; treatment [1] × time [2] |        4.59 | 1.60 | [ 1.45,  7.74] |  2.86 | 0.004 </span></span>
<span><span class="co">#&gt; treatment [1] × time [3] |       13.91 | 1.61 | [10.76, 17.05] |  8.65 | &lt; .001</span></span>
<span></span>
<span><span class="co"># contrasts of treatment levels, using g-computation</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m3</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.60 (1.84, 9.37) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="analysing-difference-in-ate">Analysing Difference in ATE<a class="anchor" aria-label="anchor" href="#analysing-difference-in-ate"></a>
</h3>
<p>The coefficient table above shows the ATE at each time point, not the
overall ATE that we calculated with <code><a href="../reference/estimate_contrasts.html">estimate_contrasts()</a></code>.
However, we can do the same using <code><a href="../reference/estimate_contrasts.html">estimate_contrasts()</a></code> and
the <code>by</code> argument. As we can see, results are fairly
similar.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># contrasts of treatment levels, using g-computation</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m3</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 | time |      Difference (CI) |      p</span></span>
<span><span class="co">#&gt; ------------------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 1    | -0.53 (-4.71,  3.64) |  0.802</span></span>
<span><span class="co">#&gt; 1      | 0      | 2    |  4.06 (-0.12,  8.24) |  0.057</span></span>
<span><span class="co">#&gt; 1      | 0      | 3    | 13.37 ( 9.19, 17.56) | &lt;0.001</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
<p>But is the <em>change</em> in the ATE between two time points
statistically significant? In other words, is the ATE increasing (or
decreasing) significantly over time? We can calculate <em>interaction
contrasts</em> (described in detail <a href="https://easystats.github.io/modelbased/articles/introduction_comparisons_1.html#does-difference-between-two-levels-of-episode-in-the-control-group-differ-from-difference-of-same-two-levels-in-the-treatment-group">in
this vignette</a>) to check this!</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m3</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span>,</span>
<span>  comparison <span class="op">=</span> <span class="st">"(b3-b1) = (b4-b2)"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter   |      Difference (CI) |     p</span></span>
<span><span class="co">#&gt; ------------------------------------------</span></span>
<span><span class="co">#&gt; b3-b1=b4-b2 | -4.59 (-7.74, -1.45) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; b3 = treatment [0], time [2]</span></span>
<span><span class="co">#&gt; b1 = treatment [0], time [1]</span></span>
<span><span class="co">#&gt; b4 = treatment [1], time [2]</span></span>
<span><span class="co">#&gt; b2 = treatment [1], time [1]</span></span></code></pre></div>
<p>Yes, the the ATE changed statistically significant between the first
and the second time point!</p>
</div>
<div class="section level3">
<h3 id="even-more-complex-scenarios">Even more complex scenarios!<a class="anchor" aria-label="anchor" href="#even-more-complex-scenarios"></a>
</h3>
<p>In even more complex scenarios, g-computation remains a valuable tool
for generating accurate estimates. This example compares “simple”
contrasts derived from an IPW model with contrasts generated from the
same model using g-computation. The results demonstrate the increased
accuracy achieved by combining IPW with g-computation in such
situations.</p>
<p>While the contrasts based solely on IPW are slightly biased with an
estimated difference of 5.99, the contrasts derived from the same model
using g-computation are close to the effect we found before, with an
estimated difference of 5.64.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># more complex model</span></span>
<span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu">glmmTMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">QoL</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">time</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">ipw</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># complex model, simple contrasts, no g-computation</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span><span class="va">m4</span>, <span class="st">"treatment"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Marginal Contrasts Analysis</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |    Difference (CI) |     p</span></span>
<span><span class="co">#&gt; --------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.99 (1.93, 10.04) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span>
<span></span>
<span><span class="co"># complex model, with IPW *and* G-computation (double-robust) is accurate!</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span><span class="va">m4</span>, <span class="st">"treatment"</span>, estimate <span class="op">=</span> <span class="st">"population"</span>, weights <span class="op">=</span> <span class="st">"ipw"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.64 (1.86, 9.42) | 0.003</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="average-treatment-effect-on-the-treated-and-untreated">Average treatment effect on the treated and untreated<a class="anchor" aria-label="anchor" href="#average-treatment-effect-on-the-treated-and-untreated"></a>
</h3>
<p>The last example completes the “causal inference” topic by showing
how to calculate the average treatment effect on the treated (ATT), and
average treatment effect on the untreated (ATU).</p>
<p>The ATT measures how much the treatment changes the outcome for those
who already received it. Likewise, the ATU estimates how much the
treatment would change the outcome if it were given to those who didn’t
already receive it.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/insight/" class="external-link">insight</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we need the data used to fit the model - this may not be</span></span>
<span><span class="co"># identical to the original data due to case-wise deletion</span></span>
<span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://easystats.github.io/insight/reference/get_data.html" class="external-link">get_data</a></span><span class="op">(</span><span class="va">m4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the ATT - apply g-computation only to the subset of the treated</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m4</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model_data</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.62 (1.84, 9.39) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span>
<span></span>
<span><span class="co"># the ATU - apply g-computation only to the subset of the conrol</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m4</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model_data</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.67 (1.89, 9.45) | 0.003</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
<p>It is helpful to calculate both ATT and ATU, as they can differ
substantially, indicating a potential bias in the selection mechanism of
receiving a treatment or not. In our example, since the ATU is larger
than the ATT, this could mean that the treated individuals are possibly
less responsive to the treatment or the untreated individuals are more
likely not to choose the intervention.</p>
<p>In ideal randomized trials, the Average Treatment Effect (ATE), the
effect on the treated (ATT), and the effect on the untreated (ATU) are
expected to be the same because randomization creates comparable groups.
However, these values often differ in observational studies or trials
with treatment non-compliance, as the groups may be systematically
different due to factors like self-selection <span class="citation">(Dong et al. 2023)</span>.</p>
</div>
<div class="section level3">
<h3 id="an-important-note-on-variance-estimators">An important note on variance estimators<a class="anchor" aria-label="anchor" href="#an-important-note-on-variance-estimators"></a>
</h3>
<p>When performing statistical inference with inverse probability
weighting (IPW), using standard variance estimators is discouraged.
These estimators often fail to account for the variance introduced by
the IPW itself, resulting in conservative standard errors for the
average treatment effect (ATE), especially when we have observations
with large or extreme weights. For the average treatment effect on the
treated (ATT), standard errors can be either over- or underestimated.
More robust methods are therefore recommended, such as bootstrapping,
using overlap or matching weights, or calculating robust standard errors
(Huber-White sandwich estimators) <span class="citation">(Gabriel et al.
2024; Kostouraki et al. 2024; Reifeis and Hudgens 2022)</span>.</p>
<p>Robust standard errors can be easily computed for many models using
the <code>vcov</code> argument within the
<code><a href="../reference/estimate_contrasts.html">estimate_contrasts()</a></code> function. Package <em>glmmTMB</em>
supports robust standard errors via the <code>sandwich</code> package
since version 1.1.12, however, currently only the <code>"HC0"</code>
option (which is equivalent to the Huber-White estimator).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># complex model, with IPW *and* G-computation (double-robust) is accurate!</span></span>
<span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span></span>
<span>  <span class="va">m4</span>,</span>
<span>  <span class="st">"treatment"</span>,</span>
<span>  vcov <span class="op">=</span> <span class="st">"HC0"</span>,</span>
<span>  estimate <span class="op">=</span> <span class="st">"population"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"ipw"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |   Difference (CI) |     p</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.64 (1.76, 9.52) | 0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span>
<span><span class="co">#&gt; p-values are uncorrected.</span></span></code></pre></div>
<p>A fully Bayesian approach, as demonstrated here, also provides a
robust alternative.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same model as m4, within a Bayesian framework, using the Stan and brms package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">QoL</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">ipw</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">time</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">*</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hospital</span> <span class="op">+</span></span>
<span>    <span class="va">age</span> <span class="op">+</span> <span class="va">phq4</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/estimate_contrasts.html">estimate_contrasts</a></span><span class="op">(</span><span class="va">m5</span>, <span class="st">"treatment"</span>, estimate <span class="op">=</span> <span class="st">"population"</span>, weights <span class="op">=</span> <span class="st">"ipw"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Counterfactual Contrasts Analysis (G-computation)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Level1 | Level2 |       Median (CI) |     pd</span></span>
<span><span class="co">#&gt; --------------------------------------------</span></span>
<span><span class="co">#&gt; 1      | 0      | 5.57 (1.79, 9.73) | 99.80%</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable predicted: QoL, ipw</span></span>
<span><span class="co">#&gt; Predictors contrasted: treatment</span></span>
<span><span class="co">#&gt; Predictors averaged: time, education, hospital (0.95), age (0.22), phq4 (-0.076), ID</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette explored the estimation of average treatment effects
(ATEs) from observational data, focusing on the application of inverse
probability weighting (IPW) and g-computation. While both methods
address confounding bias inherent in non-randomized studies, they offer
distinct strengths. IPW provides a straightforward approach for
incorporating weights into regression models, simplifying ATE
interpretation in basic models. However, g-computation excels in more
complex scenarios, such as those involving longitudinal data and
interaction terms, where isolating treatment effects becomes
challenging.</p>
<p>Our examples demonstrated the utility of both methods. Specifically,
we showed that while IPW effectively estimates the ATE in a simple
model, g-computation becomes essential when modeling the interaction
between <code>treatment</code> and <code>time</code>. IPW performs well
with rare outcomes, whereas g-computation is better suited for studies
with imbalanced treatment group sizes. Therefore, combining IPW with
g-computation, as illustrated in our last examples, offers increased
accuracy, highlighting the benefits of this “doubly robust” approach for
estimating ATEs in complex models.</p>
<p>Combining IPW and g-computation doesn’t introduce any additional bias
and hence has no negative effects. While IPW alone can sometimes be less
accurate than g-computation, particularly when g-computation is
feasible, the most reliable estimates are achieved by using both methods
together. Therefore, we recommend their combined use.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-chatton_causal_2024" class="csl-entry">
Chatton, Arthur, and Julia M. Rohrer. 2024. <span>“The
<span>Causal</span> <span>Cookbook</span>: <span>Recipes</span> for
<span>Propensity</span> <span>Scores</span>,
<span>G</span>-<span>Computation</span>, and <span>Doubly</span>
<span>Robust</span> <span>Standardization</span>.”</span> <em>Advances
in Methods and Practices in Psychological Science</em> 7 (1):
25152459241236149. <a href="https://doi.org/10.1177/25152459241236149" class="external-link">https://doi.org/10.1177/25152459241236149</a>.
</div>
<div id="ref-dickerman_counterfactual_2020" class="csl-entry">
Dickerman, Barbra A., and Miguel A. Hernán. 2020. <span>“Counterfactual
Prediction Is Not Only for Causal Inference.”</span> <em>European
Journal of Epidemiology</em> 35 (7): 615–17. <a href="https://doi.org/10.1007/s10654-020-00659-8" class="external-link">https://doi.org/10.1007/s10654-020-00659-8</a>.
</div>
<div id="ref-dong_identifying_2023" class="csl-entry">
Dong, Nianbo, Benjamin Kelcey, and Jessaca Spybrook. 2023.
<span>“Identifying and <span>Estimating</span> <span>Causal</span>
<span>Moderation</span> for <span>Treated</span> and
<span>Targeted</span> <span>Subgroups</span>.”</span> <em>Multivariate
Behavioral Research</em> 58 (2): 221–40. <a href="https://doi.org/10.1080/00273171.2022.2046997" class="external-link">https://doi.org/10.1080/00273171.2022.2046997</a>.
</div>
<div id="ref-gabriel_inverse_2024" class="csl-entry">
Gabriel, Erin E., Michael C. Sachs, Torben Martinussen, et al. 2024.
<span>“Inverse Probability of Treatment Weighting with Generalized
Linear Outcome Models for Doubly Robust Estimation.”</span>
<em>Statistics in Medicine</em> 43 (3): 534–47. <a href="https://doi.org/10.1002/sim.9969" class="external-link">https://doi.org/10.1002/sim.9969</a>.
</div>
<div id="ref-ho_matchit_2005" class="csl-entry">
Ho, Daniel, Kosuke Imai, Gary King, Elizabeth Stuart, and Noah Greifer.
2005. <em><span>MatchIt</span>: <span>Nonparametric</span>
<span>Preprocessing</span> for <span>Parametric</span>
<span>Causal</span> <span>Inference</span></em>. <a href="https://doi.org/10.32614/CRAN.package.MatchIt" class="external-link">https://doi.org/10.32614/CRAN.package.MatchIt</a>.
</div>
<div id="ref-kostouraki_variance_2024" class="csl-entry">
Kostouraki, Andriana, David Hajage, Bernard Rachet, et al. 2024.
<span>“On Variance Estimation of the Inverse Probability‐of‐treatment
Weighting Estimator: <span>A</span> Tutorial for Different Types of
Propensity Score Weights.”</span> <em>Statistics in Medicine</em> 43
(13): 2672–94. <a href="https://doi.org/10.1002/sim.10078" class="external-link">https://doi.org/10.1002/sim.10078</a>.
</div>
<div id="ref-li_weighting_2013" class="csl-entry">
Li, Liang, and Tom Greene. 2013. <span>“A <span>Weighting</span>
<span>Analogue</span> to <span>Pair</span> <span>Matching</span> in
<span>Propensity</span> <span>Score</span>
<span>Analysis</span>.”</span> <em>The International Journal of
Biostatistics</em> 9 (2). <a href="https://doi.org/10.1515/ijb-2012-0030" class="external-link">https://doi.org/10.1515/ijb-2012-0030</a>.
</div>
<div id="ref-reifeis_variance_2022" class="csl-entry">
Reifeis, Sarah A, and Michael G Hudgens. 2022. <span>“On
<span>Variance</span> of the <span>Treatment</span> <span>Effect</span>
in the <span>Treated</span> <span>When</span> <span>Estimated</span> by
<span>Inverse</span> <span>Probability</span>
<span>Weighting</span>.”</span> <em>American Journal of
Epidemiology</em> 191 (6): 1092–97. <a href="https://doi.org/10.1093/aje/kwac014" class="external-link">https://doi.org/10.1093/aje/kwac014</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://dominiquemakowski.github.io/" class="external-link">Dominique Makowski</a>, <a href="https://github.com/strengejacke" class="external-link">Daniel Lüdecke</a>, <a href="https://home.msbstats.info/" class="external-link">Mattan S. Ben-Shachar</a>, <a href="https://sites.google.com/site/indrajeetspatilmorality/" class="external-link">Indrajeet Patil</a>, <a href="https://remi-theriault.com/" class="external-link">Rémi Thériault</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>

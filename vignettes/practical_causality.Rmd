---
title: "Case Study: Casual inference for observational data using modelbased"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Case Study: Casual inference for observational data using modelbased}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set-options, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  out.width = "100%",
  dpi = 300,
  message = FALSE,
  warning = FALSE
)

options(modelbased_join_dots = FALSE)
options(modelbased_select = "minimal")

pkgs <- c("glmmTMB", "marginaleffects")

if (!all(vapply(pkgs, requireNamespace, quietly = TRUE, FUN.VALUE = logical(1L)))) {
  knitr::opts_chunk$set(eval = FALSE)
}
if (!getRversion() >= "4.1.0") {
  knitr::opts_chunk$set(eval = FALSE)
}
```

This vignette demonstrates how to perform causal inference with observational data using the `modelbased` package. While the examples below use the terms "treatment" and "control" groups, these labels are arbitrary and interchangeable. Causal inference can be applied to any scenario where observations are assigned to different conditions, regardless of whether a "treatment" in the medical sense is involved.

## The lack of randomization

Randomized controlled trials (RCTs) are frequently employed to estimate the average treatment effect (ATE), which represents the average difference in outcomes between individuals in the treatment and control groups. In the context of RCTs, the ATE can be interpreted as a causal effect.

Estimating causal effects with observational data, where treatment and control group assignments are not randomized, presents a greater challenge due to the potential for confounding bias. In observational studies, individual characteristics associated with the outcome (e.g., age, gender, education, health status) are likely unequally distributed between the treatment and control groups. This imbalance violates a key assumption for causal effect estimation, an assumption typically satisfied by randomization in RCTs but often unmet in observational data.

## Propensity scores and G-computation

There are two approaches to address the problem of missing randomization in observational data, propensity scores and G-computation.


```{r}
# example
library(easystats)
data(qol_cancer, package = "parameters")
qol_cancer$time <- as.factor(qol_cancer$time)

set.seed(123)
d <- qol_cancer |>
  data_arrange("ID") |>
  data_group("ID") |>
  data_modify(treatment = rbinom(1, 1, 0.3)) |>
  data_ungroup()

d$treatment <- as.factor(d$treatment)

m <- glm(
  treatment ~ time + hospital + phq4 + education + age,
  data = d,
  family = binomial()
)

d$predictions <- predict(m, newdata = d, type = "response")
d$wts <- ifelse(d$treatment == 1, 1 / d$predictions, 1 / (1 - d$predictions))

# no interaction - no need for contrasts
m_simple <- glmmTMB::glmmTMB(
  QoL ~ treatment + time + education + hospital + age + phq4 + (1 | ID),
  weights = wts,
  data = d
)

modelbased::estimate_contrasts(m_simple, "treatment", estimate = "population")

m1 <- glmmTMB::glmmTMB(
  QoL ~ treatment * time + education + hospital + age + phq4 + (1 | ID),
  data = d
)

m2 <- glmmTMB::glmmTMB(
  QoL ~ treatment * time + education + hospital + age + phq4 + (1 | ID),
  weights = wts,
  data = d
)

m3 <- glmmTMB::glmmTMB(
  QoL ~ treatment * time + treatment * education + hospital + age + phq4 + (1 | ID),
  data = d
)

m4 <- glmmTMB::glmmTMB(
  QoL ~ treatment * time + treatment * education + hospital + age + phq4 + (1 | ID),
  weights = wts,
  data = d
)

parameters::compare_parameters(m1, m2, m3, m4, keep = "^treatment")

modelbased::estimate_contrasts(m1, "treatment")
modelbased::estimate_contrasts(m1, "treatment", estimate = "population")

modelbased::estimate_contrasts(m3, "treatment")
modelbased::estimate_contrasts(m3, "treatment", estimate = "population")

modelbased::estimate_contrasts(m2, "treatment")
modelbased::estimate_contrasts(m2, "treatment", estimate = "population")

modelbased::estimate_contrasts(m4, "treatment")
modelbased::estimate_contrasts(m4, "treatment", estimate = "population")
```

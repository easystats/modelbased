---
title: "Mixed models"
output:
  rmarkdown::html_vignette:
    toc: true
tags: [r, programing]
vignette: >
  \usepackage[utf8]{inputenc}
  %\VignetteIndexEntry{Mixed models}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r set-options, echo = FALSE, message = FALSE}
library(knitr)
knitr::opts_chunk$set(
  package.startup.message = FALSE,
  dpi = 300,
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = TRUE
)
options(knitr.kable.NA = "", digits = 2, width = 800, modelbased_join_dots = FALSE)
pkgs <- c("ggplot2", "marginaleffects", "collapse", "Formula")
successfully_loaded <- suppressPackageStartupMessages(vapply(pkgs, requireNamespace, FUN.VALUE = logical(1L), quietly = TRUE))
can_evaluate <- all(successfully_loaded)

if (can_evaluate) {
  knitr::opts_chunk$set(eval = TRUE)
  junk <- suppressMessages(suppressPackageStartupMessages(vapply(pkgs, require, FUN.VALUE = logical(1L), quietly = TRUE, character.only = TRUE)))
} else {
  knitr::opts_chunk$set(eval = FALSE)
}
```

## Estimated Marginal Means in Mixed Models: Navigating Conditional and Marginal Effects

Mixed models, with their ability to account for hierarchical or clustered data, offer powerful tools for understanding complex relationships. A key aspect of interpreting these models is understanding **estimated marginal means (EMMs)**, which represent the predicted outcome for specific groups or conditions, while holding other variables constant. However, calculating EMMs in mixed models is not always straightforward, and the results can vary depending on the approach taken.

One crucial distinction is between **conditional** and **marginal** predictions (or effects). Conditional predictions are specific to a particular level of the random effect (e.g., the predicted outcome for a specific individual in a study). Marginal predictions, on the other hand, average over the random effects, providing an overall estimate of the effect in the population. This is a crucial difference, as the marginal effect is often the quantity of interest when we want to generalize to the population.

When working with mixed models, the `modelbased` package offers flexibility in calculating EMMs through different backends. The `"marginaleffects"` backend and the `"emmeans"` backend are two popular choices, but they employ different underlying methodologies. `marginaleffects` typically focuses on marginal predictions by averaging over the random effects, while `emmeans` provides conditional predictions. Consequently, the EMMs obtained using these two backends may differ, particularly for imbalanced groups, or when models are not Gaussian.

In essence, the choice of backend and the understanding of whether we are looking at conditional or marginal predictions are critical for correctly interpreting the results of mixed models. Carefully considering the research question and the nature of the random effects will guide the selection of the appropriate approach.

**Add reference: Heiss, A. (2022). Marginal and conditional effects for GLMMs with marginaleffects. Andrew Heiss. \doi{10.59350/xwnfm-x1827}**

```{r}
data("fish", package = "insight")
m1 <- glmmTMB::glmmTMB(
  count ~ child + camper + (1 | persons),
  data = fish,
  family = poisson()
)

estimate_means(m1, "camper")
estimate_means(m1, "camper", backend = "emmeans")

estimate_means(m1, "camper", estimate = "average")


m2 <- glm(
  count ~ child + camper,
  data = fish,
  family = poisson()
)

estimate_means(m2, "camper")
estimate_means(m2, "camper", backend = "emmeans")

estimate_means(m2, "camper", estimate = "average")

data(sleepstudy, package = "lme4")
set.seed(1234)
sleepstudy$x <- as.factor(sample.int(3, nrow(sleepstudy), replace = TRUE))
m3 <- lme4::lmer(Reaction ~ Days + (1 + Days | Subject), data = sleepstudy)

estimate_means(m3, "Days")
estimate_means(m3, "Days", backend = "emmeans")

estimate_means(m3, "Days", estimate = "average")

m4 <- lme4::lmer(Reaction ~ Days + x + (1 + Days | Subject), data = sleepstudy)

estimate_means(m4, "x")
estimate_means(m4, "x", backend = "emmeans")

estimate_means(m4, "x", estimate = "average")

```
